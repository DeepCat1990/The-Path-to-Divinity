 
# The Path to Divinity

> **项目简介**: 该项目旨在通过模块化设计和数据驱动架构，深入探索软件架构设计的核心理念。

## 快速开始

### 运行游戏

**方式一：智能启动（推荐）**
```bash
python run_game.py
```
- 自动检测GUI依赖
- 有PySide6时启动图形界面
- 无GUI依赖时启动控制台版本

**方式二：图形界面版本**
```bash
# 先安装依赖
pip install PySide6

# 启动游戏
python main.py
```

**方式三：控制台版本**
```bash
python run_game.py
```

**方式四：核心功能测试**
```bash
python test_core.py
```

### 游戏功能

#### 已实现功能
- ✅ **角色系统**: 修为、年龄、天赋等属性管理
- ✅ **修炼系统**: 通过修炼提升修为和属性
- ✅ **技能系统**: 学习功法和法术
- ✅ **法术系统**: 施放各种法术，消耗法力
- ✅ **奇遇系统**: 随机触发的冒险事件
- ✅ **战斗系统**: 自动战斗，伤害计算
- ✅ **物品系统**: 背包管理，物品使用
- ✅ **时间系统**: 游戏内时间流逝
- ✅ **ECS架构**: 实体组件系统
- ✅ **事件驱动**: 全局事件总线
- ✅ **数据驱动**: JSON配置文件

#### 游戏操作
- **修炼**: 提升修为，可能学会新功法
- **历练**: 外出冒险，触发奇遇事件
- **测试法术**: 施放已学会的法术
- **测试奇遇**: 强制触发奇遇事件

#### 核心特色
- **最小可行性**: 每个功能都保持最简实现
- **模块化设计**: 各系统独立，易于扩展
- **事件驱动**: 系统间通过事件通信
- **数据驱动**: 游戏内容由JSON文件定义

## 项目概述

### 核心数据层 (Data Core)
这一层是所有游戏内容的“蓝图”，完全由数据文件构成。

#### 配置文件 (JSON/YAML/Database)

- `Character_template.json`: 定义角色模板（玩家、NPC、怪物），包含基础属性（根骨、悟性、魅力等）。
- `Gongfa.json`: 功法/法术库。定义所有功法，包括名称、描述、学习条件、每层效果（如增加属性、解锁新法术）、关联的法术ID。
- `Spell.json`: 法术/技能库。定义所有具体法术，包括ID、消耗（灵力、神识）、效果（伤害、治疗、Buff）。
- `Item.json`: 物品库。定义所有物品（丹药、材料、法宝、装备），包含ID、类型、效果、堆叠上限等。
- `Quest.json`: 任务库。定义任务链和目标。
- `Encounter.json`: 奇遇库。定义所有随机奇遇事件，包含触发条件、选项和结果。
- `Realm.json`: 境界库。定义所有境界，包含晋升条件、寿命加成、属性加成等。

---

### 基础系统层 (Foundation Systems)

这一层是游戏世界运行的基础规则和引擎。

#### 实体组件系统 (Entity-Component-System, ECS)

- **实体 (Entity)**: 游戏世界中的万物（玩家、NPC、掉落物、法术弹道）都只是一个ID。
- **组件 (Component)**: 附加到实体上的纯数据块。这是架构的核心。
  - `AttributeComponent`: 存储角色的所有数值属性（生命、灵力、攻击、防御、五行灵根、寿命…）。
  - `SkillComponent`: 存储该实体已学会的法术ID列表。
  - `StateComponent`: 存储当前状态（中毒、眩晕、燃烧、筑基期…）。
  - `InventoryComponent`: 背包组件，存储物品ID和数量。
  - `EquipmentComponent`: 装备组件，管理已穿戴的法宝。

- **系统 (System)**: 处理拥有特定组件组合的实体的逻辑。例如，`PhysicsSystem` 只处理有 `PositionComponent` 和 `VelocityComponent` 的实体。

#### 事件总线 (Global Event Bus)

一个全局的单例，负责事件的发布和订阅。

示例：
```javascript
EventManager.publish('OnSpellCast', caster_id, spell_id);
```
任何关心施法事件的模块都可以订阅它。

#### 游戏世界管理器 (World Manager)

- 管理所有实体和系统。
- 负责游戏主循环（Game Loop），在每一帧更新所有系统。
- 管理场景加载、时间流逝（影响角色寿命、药草生长）。

---

### 功能模块层 (Feature Modules)

这一层是玩家能直接感知到的具体游戏玩法，它们依赖基础系统层来实现。

#### 角色系统 (Character System)

- **功能**:
  - 监听 `OnExperienceGained` 事件来增加经验，满足条件时发布 `OnLevelUp` 事件。
  - 管理寿命，当寿命耗尽时发布 `OnCharacterDeath` 事件。

#### 战斗系统 (Combat System) - 【可扩展点】

- **基础框架**: 监听 `RequestCastSpell` 事件。当事件发生时，它会检查施法者的 `AttributeComponent`（灵力是否足够）、`StateComponent`（是否被沉默），然后计算法术效果。
- **伤害计算**: 从施法者的属性、目标的状态、法术的 `Spell.json` 数据中获取所有信息，通过一个可配置的“伤害公式”计算最终伤害。

示例：
```text
物理伤害: 攻击力 + 暴击 - 防御
法术伤害: 法术攻击 + 元素加成 + 暴击
```

#### 法术系统 (Spell System) - 【可扩展点】

- **核心**: 它本身不包含复杂逻辑，主要是一个数据接口。当需要施法时，从 `SkillComponent` 中读取法术ID，然后去 `Spell.json` 和 `Gongfa.json` 中查找详细数据。
- **效果处理器 (Effect Processor)**: 这是扩展的关键。每个法术的效果（Effect）可以是一个独立的子模块。
  - `DamageEffect`: 造成伤害。
  - `HealEffect`: 恢复生命。
  - `ApplyStateEffect`: 施加一个状态（如“中毒”）。
  - `SummonEffect`: 召唤一个生物。

> **扩展**: 当你想创建一个全新的法术时，只需：
> 1. 在 `Spell.json` 中定义一个新的法术条目。
> 2. 为其指定一个或多个已有的“效果处理器”。
> 3. 如果需要全新效果（如“时间倒流”），只需编写一个新的 `TimeRewindEffect` 处理器，而无需改动法术系统本身。

#### 奇遇系统 (Encounter System) - 【可扩展点】

- **触发器 (Trigger)**: 这是一个监听各种游戏事件的模块。
  - `LocationTrigger`: 玩家进入某个区域时触发。
  - `TimeTrigger`: 游戏内时间到达某个点时触发。
  - `AttributeTrigger`: 玩家某个属性（如心魔、声望）达到某个值时触发。
- **执行器 (Executor)**: 当触发器被激活，它会从 `Encounter.json` 中随机或按权重抽取一个奇遇事件。
- **事件链**: 奇遇事件本身可以是一个简单的结果（获得物品），也可以是一个包含多选项、多分支的复杂事件链，每个选项都会发布新的事件或修改玩家的组件数据。

> **扩展**: 添加新奇遇，只需在 `Encounter.json` 中增加一个条目，并设计好它的触发条件和结果即可，完全无需修改代码。

#### 其他模块

- **背包/物品系统**: 管理 `InventoryComponent` 和 `Item.json`。
- **任务系统**: 管理 `Quest.json` 和玩家的任务进度。
- **AI系统**: 控制NPC，通过读取其组件数据并在每回合发布他们的修仙之路的行为。

---

### 核心特性

- **事件驱动架构**: 所有模块通过事件通信。
- **高度可扩展**: 新功能只需添加处理器或触发器。
- **数据驱动**: 所有内容由 JSON 配置。
- **模块化设计**: 各模块独立，易于维护。

---

### 扩展示例

- **新法术效果**: 只需实现新的 `EffectProcessor`。
- **新奇遇触发**: 只需实现新的 `Trigger`。
- **新战斗机制**: 只需扩展 `DamageCalculator`。

---

## 技术实现

### 项目结构
```
core/                 # 核心系统
├── ecs/             # 实体组件系统
├── modules/         # 功能模块
├── game.py          # 游戏主类
├── events.py        # 事件系统
└── data_manager.py  # 数据管理

data/                # 游戏数据
├── spell.json       # 法术定义
├── techniques.json  # 功法定义
├── encounter.json   # 奇遇事件
└── item.json        # 物品定义

ui/                  # 用户界面
└── main_window.py   # 主窗口
```

### 核心系统说明

1. **ECS架构**: 实体只是ID，组件存储数据，系统处理逻辑
2. **事件总线**: 全局事件系统，解耦各模块
3. **数据驱动**: 所有游戏内容由JSON文件定义
4. **模块化**: 每个功能独立模块，易于维护

### 开发特点

- **最小可行性**: 每个功能都是最简实现
- **易于扩展**: 新功能只需添加处理器
- **数据分离**: 逻辑与数据完全分离
- **事件驱动**: 松耦合的系统架构

系统架构清晰，为复杂修仙玩法提供了坚实基础。